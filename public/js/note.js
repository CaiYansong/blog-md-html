var client=getUrlParam("client"),username=getUsername();function setUsername(e){localStorage.setItem("username-key",e)}function getUsername(){return localStorage.getItem("username-key")}username||setUsername(username=(client||"note").toLowerCase()+"_"+Date.now());var noteTpl='<div class="note-item"> <div class="note-content">{content}</div> <div class="note-info"> <span class="datetime">{datetime}</span> <div class="note-options"> <button class="edit-btn" data-type="edit" data-id="{id}">编辑</button> <button class="devare-btn" data-type="del" data-id="{id}">删除</button> </div> </div> </div>',textAreaEle=document.getElementById("text-ipt"),noteWrapEle=document.getElementById("notes-wrap"),saveBtn=document.getElementById("save-btn"),editBtn=document.getElementById("edit-btn"),clearBtn=document.getElementById("clear-btn"),tipsEle=document.getElementById("tips"),editId=null,tempKey="temp";function init(){setDateFormat(),saveBtn.addEventListener("click",function(){var e=textAreaEle.value;e?addNote(escapeHTML(e),function(){textAreaEle.value="",tipsEle.innerHTML="",renderNoteList(!0),localStorage.setItem(tempKey,"")}):tipsEle.innerHTML="不能为空"}),editBtn.addEventListener("click",function(){updateNote(escapeHTML(textAreaEle.value),function(){renderNoteList(!0),textAreaEle.value="",editBtn.className=editBtn.className+" hide",saveBtn.className=saveBtn.className.replace(" hide",""),localStorage.setItem(tempKey,"")})}),noteWrapEle.addEventListener("click",function(e){var t=e.target.getAttribute("data-type"),n=e.target.getAttribute("data-id");"del"===t&&removeNote(n,function(){renderNoteList()}),"edit"===t&&readNote(n,function(e){editId=n,textAreaEle.value=e.val,saveBtn.className=saveBtn.className+" hide",editBtn.className=editBtn.className.replace(" hide","")})}),clearBtn.addEventListener("click",function(){textAreaEle.value="",localStorage.setItem(tempKey,""),clearBtn.className=clearBtn.className+" hide"}),textAreaEle.addEventListener("keydown",function(){localStorage.setItem(tempKey,escapeHTML(textAreaEle.value))})}function onDBLoad(){renderNoteList()}function renderNoteList(e){readNotes(function(t){var n=(t||[]).reverse(),a="";n&&n.forEach&&n.forEach(function(e){var t=noteTpl;t=(t=(t=(t=t.replace(/\{id\}/g,e.id)).replace(/\{content\}/g,e.val)).replace(/\{datetime\}/g,e.datetime)).replace(/\{time\}/g,e.time),a+=t}),noteWrapEle.innerHTML=a,e&&n.length>0&&postInfoToIframe(JSON.stringify(n))})}init(),window.onload=function(){var e=localStorage.getItem(tempKey);e&&(logInfo("load temp val"),clearBtn.className=clearBtn.className.replace(" hide",""),textAreaEle.value=descapeHTML(e))};var hasIndexedDB=indexedDB||webkitIndexedDB||mozIndexedDB||null;function addNote(e,t){var n=new Date,a=n.getTime(),o={id:""+a,val:e,time:a,datetime:n.format()};hasIndexedDB?add(o,t):addItem(o,t)}function updateNote(e,t){var n=new Date,a={id:editId,val:e,time:n.getTime(),datetime:n.format()};hasIndexedDB?update(a,t):updateItem(a,t)}function removeNote(e,t){hasIndexedDB?remove(e,t):removeItem(e,t)}function readNotes(e){hasIndexedDB?!1===readAll(e)&&getList(e):getList(e)}function readNote(e,t){hasIndexedDB?read(e,t):getItem(e,t)}logInfo("href: "+window.location.href);var deviceInfo=void 0,targetUrl="https://caiyansong.com",noteIframeWindow=document.getElementById("note-iframe").contentWindow;function postInfoToIframe(e){e&&postMessageToIframe(e,username)}function postMessageToIframe(e,t){noteIframeWindow.postMessage({type:"post",str:e,title:t},targetUrl),logInfo("postMessage end")}function getMessage(){noteIframeWindow.postMessage({type:"get"},targetUrl)}function getUrlParam(e){for(var t=window.location.search.substring(1).split("&"),n=0;n<t.length;n++){var a=t[n].split("=");if(a[0]==e)return a[1]}return""}function setDateFormat(){Date.prototype.format=function(e){var t=e||"yyyy-MM-dd 星期w hh:mm:ss";return t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/yyyy|YYYY/,this.getFullYear())).replace(/yy|YY/,this.getYear()%100>9?(this.getYear()%100).toString():"0"+this.getYear()%100)).replace(/MM/,this.getMonth()+1>9?(this.getMonth()+1).toString():"0"+(this.getMonth()+1))).replace(/M/g,this.getMonth()+1)).replace(/w|W/g,["日","一","二","三","四","五","六"][this.getDay()])).replace(/dd|DD/,this.getDate()>9?this.getDate().toString():"0"+this.getDate())).replace(/d|D/g,this.getDate())).replace(/hh|HH/,this.getHours()>9?this.getHours().toString():"0"+this.getHours())).replace(/h|H/g,this.getHours())).replace(/mm/,this.getMinutes()>9?this.getMinutes().toString():"0"+this.getMinutes())).replace(/m/g,this.getMinutes())).replace(/ss|SS/,this.getSeconds()>9?this.getSeconds().toString():"0"+this.getSeconds())).replace(/s|S/g,this.getSeconds())}}function escapeHTML(e){if("string"!=typeof e)return"";return e.replace(/"|&|'|<|>|[\x00-\x20]|[\x7F-\xFF]|[\u0100-\u2700]/g,function(e){var t=e.charCodeAt(0),n=["&#"];return t=32===t?160:t,n.push(t),n.push(";"),n.join("")})}function descapeHTML(e){if("string"!=typeof e)return"";var t=document.getElementById("temp-descape-html");return t||((t=document.createElement("div")).id="temp-descape-html"),t.innerHTML=e,t.innerText}function logInfo(e){var t="string"==typeof e?e:e.toString();console.log("Log: "+e);var n=document.getElementById("log-info");n.innerText=n.innerText+"\nLog: "+t}window.addEventListener("message",function(e){console.log("main listener",e.origin,e,e.data),e.origin});var key="notes";function addItem(e,t){var n=getList();n.push(e),localStorage.setItem(key,JSON.stringify(n)),t&&t()}function updateItem(e,t){for(var n=getList(),a=0;a<n.length;a++){if(n[a].id==e.id){var o=new Date;n[a]={id:e.id,val:e.val,time:o.getTime(),datetime:o.format()};break}}localStorage.setItem(key,JSON.stringify(n)),t&&t()}function removeItem(e,t){for(var n=getList(),a=-1,o=0;o<n.length;o++){if(n[o].id==e){a=o;break}}n.splice(a,1),localStorage.setItem(key,JSON.stringify(n)),t&&t()}function getList(e){var t=JSON.parse(localStorage.getItem(key))||[];return e&&e(t),t}function getItem(e,t){for(var n=getList(),a=0;a<n.length;a++){var o=n[a];if(o.id==e){t&&t(o);break}}}var db,indexedDBObj=indexedDB||webkitIndexedDB||mozIndexedDB||null,databaseName="notesDB",indexName="notesIndex",request=indexedDBObj.open(databaseName,1);function add(e,t){if(db){var n=db.transaction([indexName],"readwrite").objectStore(indexName).add(e);n.onsuccess=function(){t&&t()},n.onerror=function(){logInfo("数据写入失败")}}}function remove(e,t){db&&(db.transaction([indexName],"readwrite").objectStore(indexName).delete(e).onsuccess=function(){t&&t()})}function update(e,t){if(db){var n=db.transaction([indexName],"readwrite").objectStore(indexName).put(e);n.onsuccess=function(){t&&t()},n.onerror=function(){logInfo("数据更新失败")}}}function read(e,t){if(db){var n=db.transaction(indexName).objectStore(indexName).get(e);n.onerror=function(){logInfo("事务失败")},n.onsuccess=function(){n.result?t&&t(n.result):logInfo("未获得数据记录")}}}function readAll(e){if(!db)return!1;var t=db.transaction(indexName).objectStore(indexName),n=[];t.openCursor().onsuccess=function(t){var a=t.target.result;a?(n.push(a.value),a.continue()):e&&e(n)}}function findOne(e,t,n){db&&(db.transaction([indexName],"readonly").objectStore(indexName).index(e).get(t).onsuccess=function(e){var t=e.target.result;t&&n&&n(t)})}request.onsuccess=function(){(db=request.result)?(hasIndexedDB=!0,logInfo("数据库打开成功"),onDBLoad()):hasIndexedDB=!1},request.onerror=function(e){logInfo("数据库打开报错: "+e)},request.onupgradeneeded=function(e){var t;(db=e.target.result).objectStoreNames.contains(indexName)||((t=db.createObjectStore(indexName,{keyPath:"id"})).createIndex("val","val",{unique:!1}),t.createIndex("time","time",{unique:!1}),t.createIndex("datetime","datetime",{unique:!1}))};