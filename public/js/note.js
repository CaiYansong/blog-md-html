var client=getUrlParam("client"),username=getUsername();username||(username=(client||"note").toLowerCase()+"_"+Date.now(),setUsername(username));function setUsername(a){localStorage.setItem("username-key",a)}function getUsername(){return localStorage.getItem("username-key")}
var noteTpl='<div class="note-item"> <div class="note-content">{content}</div> <div class="note-info"> <span class="datetime">{datetime}</span> <div class="note-options"> <button class="edit-btn" data-type="edit" data-id="{id}">\u7f16\u8f91</button> <button class="devare-btn" data-type="del" data-id="{id}">\u5220\u9664</button> </div> </div> </div>',textAreaEle=document.getElementById("text-ipt"),noteWrapEle=document.getElementById("notes-wrap"),saveBtn=document.getElementById("save-btn"),editBtn=
document.getElementById("edit-btn"),clearBtn=document.getElementById("clear-btn"),tipsEle=document.getElementById("tips"),editId=null,tempKey="temp";init();
function init(){setDateFormat();saveBtn.addEventListener("click",function(){var a=textAreaEle.value;a?addNote(escapeHTML(a),function(){textAreaEle.value="";tipsEle.innerHTML="";renderNoteList(!0);localStorage.setItem(tempKey,"")}):tipsEle.innerHTML="\u4e0d\u80fd\u4e3a\u7a7a"});editBtn.addEventListener("click",function(){updateNote(escapeHTML(textAreaEle.value),function(){renderNoteList(!0);textAreaEle.value="";editBtn.className+=" hide";saveBtn.className=saveBtn.className.replace(" hide","");localStorage.setItem(tempKey,
"")})});noteWrapEle.addEventListener("click",function(a){var b=a.target.getAttribute("data-type"),c=a.target.getAttribute("data-id");"del"===b&&removeNote(c,function(){renderNoteList()});"edit"===b&&readNote(c,function(a){editId=c;textAreaEle.value=a.val;saveBtn.className+=" hide";editBtn.className=editBtn.className.replace(" hide","")})});clearBtn.addEventListener("click",function(){textAreaEle.value="";localStorage.setItem(tempKey,"");clearBtn.className+=" hide"});textAreaEle.addEventListener("keydown",
function(){localStorage.setItem(tempKey,escapeHTML(textAreaEle.value))})}window.onload=function(){var a=localStorage.getItem(tempKey);a&&(logInfo("load temp val"),clearBtn.className=clearBtn.className.replace(" hide",""),textAreaEle.value=descapeHTML(a))};function onDBLoad(){renderNoteList()}
function renderNoteList(a){readNotes(function(b){b=(b||[]).reverse();var c="";b&&b.forEach&&b.forEach(function(a){var b=noteTpl;b=b.replace(/\{id\}/g,a.id);b=b.replace(/\{content\}/g,a.val);b=b.replace(/\{datetime\}/g,a.datetime);b=b.replace(/\{time\}/g,a.time);c+=b});noteWrapEle.innerHTML=c;a&&0<b.length&&postInfoToIframe(JSON.stringify(b))})}var hasIndexedDB=indexedDB||webkitIndexedDB||mozIndexedDB||null;
function addNote(a,b){var c=new Date,d=c.getTime();a={id:""+d,val:a,time:d,datetime:c.format()};hasIndexedDB?add(a,b):addItem(a,b)}function updateNote(a,b){var c=new Date;a={id:editId,val:a,time:c.getTime(),datetime:c.format()};hasIndexedDB?update(a,b):updateItem(a,b)}function removeNote(a,b){hasIndexedDB?remove(a,b):removeItem(a,b)}function readNotes(a){hasIndexedDB?!1===readAll(a)&&getList(a):getList(a)}function readNote(a,b){hasIndexedDB?read(a,b):getItem(a,b)}logInfo("href: "+window.location.href);
var deviceInfo=void 0,targetUrl="https://caiyansong.com",noteIframeWindow=document.getElementById("note-iframe").contentWindow;window.addEventListener("message",function(a){console.log("main listener",a.origin,a,a.data)});function postInfoToIframe(a){a&&postMessageToIframe(a,username)}function postMessageToIframe(a,b){noteIframeWindow.postMessage({type:"post",str:a,title:b},targetUrl);logInfo("postMessage end")}function getMessage(){noteIframeWindow.postMessage({type:"get"},targetUrl)}
function getUrlParam(a){for(var b=window.location.search.substring(1).split("&"),c=0;c<b.length;c++){var d=b[c].split("=");if(d[0]==a)return d[1]}return""}
function setDateFormat(){Date.prototype.format=function(a){a=(a||"yyyy-MM-dd \u661f\u671fw hh:mm:ss").replace(/yyyy|YYYY/,this.getFullYear());a=a.replace(/yy|YY/,9<this.getYear()%100?(this.getYear()%100).toString():"0"+this.getYear()%100);a=a.replace(/MM/,9<this.getMonth()+1?(this.getMonth()+1).toString():"0"+(this.getMonth()+1));a=a.replace(/M/g,this.getMonth()+1);a=a.replace(/w|W/g,"\u65e5\u4e00\u4e8c\u4e09\u56db\u4e94\u516d".split("")[this.getDay()]);a=a.replace(/dd|DD/,9<this.getDate()?this.getDate().toString():
"0"+this.getDate());a=a.replace(/d|D/g,this.getDate());a=a.replace(/hh|HH/,9<this.getHours()?this.getHours().toString():"0"+this.getHours());a=a.replace(/h|H/g,this.getHours());a=a.replace(/mm/,9<this.getMinutes()?this.getMinutes().toString():"0"+this.getMinutes());a=a.replace(/m/g,this.getMinutes());a=a.replace(/ss|SS/,9<this.getSeconds()?this.getSeconds().toString():"0"+this.getSeconds());return a=a.replace(/s|S/g,this.getSeconds())}}
function escapeHTML(a){return"string"!==typeof a?"":a.replace(/"|&|'|<|>|[\x00-\x20]|[\x7F-\xFF]|[\u0100-\u2700]/g,function(a){a=a.charCodeAt(0);var b=["&#"];b.push(32===a?160:a);b.push(";");return b.join("")})}function descapeHTML(a){if("string"!==typeof a)return"";var b=document.getElementById("temp-descape-html");b||(b=document.createElement("div"),b.id="temp-descape-html");b.innerHTML=a;return b.innerText}
function logInfo(a){var b="string"===typeof a?a:a.toString();console.log("Log: "+a);a=document.getElementById("log-info");a.innerText=a.innerText+"\nLog: "+b}var key="notes";function addItem(a,b){var c=getList();c.push(a);localStorage.setItem(key,JSON.stringify(c));b&&b()}function updateItem(a,b){for(var c=getList(),d=0;d<c.length;d++)if(c[d].id==a.id){var e=new Date;c[d]={id:a.id,val:a.val,time:e.getTime(),datetime:e.format()};break}localStorage.setItem(key,JSON.stringify(c));b&&b()}
function removeItem(a,b){for(var c=getList(),d=-1,e=0;e<c.length;e++)if(c[e].id==a){d=e;break}c.splice(d,1);localStorage.setItem(key,JSON.stringify(c));b&&b()}function getList(a){var b=JSON.parse(localStorage.getItem(key))||[];a&&a(b);return b}function getItem(a,b){for(var c=getList(),d=0;d<c.length;d++){var e=c[d];if(e.id==a){b&&b(e);break}}}var indexedDBObj=indexedDB||webkitIndexedDB||mozIndexedDB||null,databaseName="notesDB",indexName="notesIndex",request=indexedDBObj.open(databaseName,1),db;
request.onsuccess=function(){(db=request.result)?(hasIndexedDB=!0,logInfo("\u6570\u636e\u5e93\u6253\u5f00\u6210\u529f"),onDBLoad()):hasIndexedDB=!1};request.onerror=function(a){logInfo("\u6570\u636e\u5e93\u6253\u5f00\u62a5\u9519: "+a)};request.onupgradeneeded=function(a){db=a.target.result;db.objectStoreNames.contains(indexName)||(a=db.createObjectStore(indexName,{keyPath:"id"}),a.createIndex("val","val",{unique:!1}),a.createIndex("time","time",{unique:!1}),a.createIndex("datetime","datetime",{unique:!1}))};
function add(a,b){db&&(a=db.transaction([indexName],"readwrite").objectStore(indexName).add(a),a.onsuccess=function(){b&&b()},a.onerror=function(){logInfo("\u6570\u636e\u5199\u5165\u5931\u8d25")})}function remove(a,b){db&&(db.transaction([indexName],"readwrite").objectStore(indexName).delete(a).onsuccess=function(){b&&b()})}
function update(a,b){db&&(a=db.transaction([indexName],"readwrite").objectStore(indexName).put(a),a.onsuccess=function(){b&&b()},a.onerror=function(){logInfo("\u6570\u636e\u66f4\u65b0\u5931\u8d25")})}function read(a,b){if(db){var c=db.transaction(indexName).objectStore(indexName).get(a);c.onerror=function(){logInfo("\u4e8b\u52a1\u5931\u8d25")};c.onsuccess=function(){c.result?b&&b(c.result):logInfo("\u672a\u83b7\u5f97\u6570\u636e\u8bb0\u5f55")}}}
function readAll(a){if(!db)return!1;var b=[];db.transaction(indexName).objectStore(indexName).openCursor().onsuccess=function(c){(c=c.target.result)?(b.push(c.value),c.continue()):a&&a(b)}}function findOne(a,b,c){db&&(db.transaction([indexName],"readonly").objectStore(indexName).index(a).get(b).onsuccess=function(a){(a=a.target.result)&&c&&c(a)})};